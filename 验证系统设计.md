# 用户验证和统计系统设计

## 🎯 目标
- 统计使用人数
- 验证用户（防止滥用）
- **不保存**学号、密码等敏感信息
- 成本控制在10元/月

---

## 🏗️ 技术方案

### 方案：设备指纹 + 简单验证

```
首次使用：
1. 用户打开软件
2. 生成设备指纹（机器唯一ID）
3. 发送到服务器注册
4. 服务器返回：允许使用

再次使用：
1. 读取本地设备指纹
2. 发送到服务器验证
3. 服务器检查是否已注册
4. 返回：允许/拒绝
```

---

## 💻 客户端实现

### 生成设备指纹

```powershell
function Get-DeviceFingerprint {
    # 获取多个硬件信息组合
    $cpu = (Get-WmiObject Win32_Processor).ProcessorId
    $board = (Get-WmiObject Win32_BaseBoard).SerialNumber
    $disk = (Get-WmiObject Win32_DiskDrive | Select-Object -First 1).SerialNumber
    
    $combined = "$cpu-$board-$disk"
    
    # 生成哈希
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($combined)
    $hash = [System.Security.Cryptography.SHA256]::Create().ComputeHash($bytes)
    $fingerprint = [BitConverter]::ToString($hash).Replace('-','').Substring(0,32)
    
    return $fingerprint
}

function Register-Device {
    param(
        [string]$SchoolId
    )
    
    $fingerprint = Get-DeviceFingerprint
    
    # 发送到服务器
    $body = @{
        device_id = $fingerprint
        school_id = $SchoolId
        os_version = [System.Environment]::OSVersion.VersionString
        timestamp = (Get-Date).ToString('o')
    } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod `
            -Uri "https://your-server.com/api/register" `
            -Method POST `
            -Body $body `
            -ContentType "application/json" `
            -TimeoutSec 5
        
        if ($response.success) {
            # 保存激活信息
            $activation = @{
                device_id = $fingerprint
                school_id = $SchoolId
                activated_at = Get-Date
            } | ConvertTo-Json
            
            $stableDir = Join-Path $env:APPDATA 'CampusNet'
            $activation | Out-File (Join-Path $stableDir 'activation.json') -Encoding UTF8
            
            return $true
        }
    } catch {
        # 网络错误时，允许离线使用（宽松策略）
        Write-Host "网络验证失败，允许离线使用"
        return $true
    }
    
    return $false
}

function Verify-Device {
    $activationFile = Join-Path $env:APPDATA 'CampusNet\activation.json'
    
    if (-not (Test-Path $activationFile)) {
        return $false
    }
    
    $activation = Get-Content $activationFile | ConvertFrom-Json
    $currentFingerprint = Get-DeviceFingerprint
    
    # 本地验证
    if ($activation.device_id -eq $currentFingerprint) {
        
        # 定期在线验证（7天一次）
        if ((Get-Date) - [DateTime]$activation.activated_at -gt [TimeSpan]::FromDays(7)) {
            # 发送心跳到服务器
            try {
                Invoke-RestMethod `
                    -Uri "https://your-server.com/api/heartbeat" `
                    -Method POST `
                    -Body (@{device_id=$currentFingerprint} | ConvertTo-Json) `
                    -ContentType "application/json" `
                    -TimeoutSec 5
            } catch {
                # 网络错误，忽略
            }
        }
        
        return $true
    }
    
    return $false
}
```

---

## 🖥️ 服务器实现（Node.js）

### 极简API（10元服务器能跑）

```javascript
// server.js
const express = require('express');
const fs = require('fs');
const app = express();

app.use(express.json());

// 简单的文件存储（后期可以换数据库）
const DATA_FILE = './devices.json';

// 加载数据
let devices = [];
if (fs.existsSync(DATA_FILE)) {
    devices = JSON.parse(fs.readFileSync(DATA_FILE, 'utf8'));
}

// 保存数据
function saveDevices() {
    fs.writeFileSync(DATA_FILE, JSON.stringify(devices, null, 2));
}

// 注册设备
app.post('/api/register', (req, res) => {
    const { device_id, school_id, os_version } = req.body;
    
    // 检查是否已注册
    const existing = devices.find(d => d.device_id === device_id);
    
    if (existing) {
        existing.last_active = new Date();
        saveDevices();
        return res.json({ success: true, message: '设备已注册' });
    }
    
    // 新设备
    devices.push({
        device_id,
        school_id,
        os_version,
        registered_at: new Date(),
        last_active: new Date()
    });
    
    saveDevices();
    
    console.log(`新设备注册：${school_id} - 总数：${devices.length}`);
    
    res.json({ success: true, message: '注册成功' });
});

// 心跳（更新活跃时间）
app.post('/api/heartbeat', (req, res) => {
    const { device_id } = req.body;
    
    const device = devices.find(d => d.device_id === device_id);
    
    if (device) {
        device.last_active = new Date();
        saveDevices();
    }
    
    res.json({ success: true });
});

// 统计信息（供你查看）
app.get('/api/stats', (req, res) => {
    const stats = {
        total_devices: devices.length,
        by_school: {}
    };
    
    devices.forEach(d => {
        if (!stats.by_school[d.school_id]) {
            stats.by_school[d.school_id] = 0;
        }
        stats.by_school[d.school_id]++;
    });
    
    res.json(stats);
});

app.listen(3000, () => {
    console.log('服务器运行在端口 3000');
});
```

### 部署到10元服务器

```bash
# 1. 安装Node.js
curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -
sudo yum install -y nodejs

# 2. 创建项目
mkdir xiaoci-server && cd xiaoci-server
npm init -y
npm install express

# 3. 上传 server.js

# 4. 使用PM2运行（自动重启）
npm install -g pm2
pm2 start server.js
pm2 save
pm2 startup

# 5. 配置Nginx反向代理（可选）
# 让你的域名指向这个API
```

---

## 📊 统计查看

### 访问统计
```
http://your-server.com/api/stats

返回示例：
{
  "total_devices": 156,
  "by_school": {
    "jci": 89,
    "jingdezhen_ceramic": 45,
    "jingdezhen_college": 22
  }
}
```

---

## 💰 成本分析

### 10元/月服务器能支撑：
- ✅ 10,000+ 注册设备
- ✅ 100,000+ API请求/月
- ✅ 简单的文件存储（devices.json）

### 扩展方案（如果用户量大）：
- 改用SQLite（免费）
- 或使用云数据库（约50元/月）

---

## 🔒 隐私保护

### 我们收集什么：
✅ 设备指纹（无法反推个人信息）
✅ 学校ID
✅ 操作系统版本
✅ 注册时间

### 我们不收集：
❌ 学号
❌ 密码
❌ 姓名
❌ 手机号
❌ IP地址（可选）

