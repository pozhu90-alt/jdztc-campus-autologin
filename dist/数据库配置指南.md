# 小瓷连网 - 数据库持久化配置指南

## 📋 配置步骤清单

### ✅ 第一步：开通腾讯云 MongoDB

1. 登录腾讯云控制台：https://console.cloud.tencent.com
2. 搜索 "MongoDB"，进入 "云数据库 MongoDB"
3. 点击 "新建实例"
4. 配置选择：
   ```
   计费模式：按量计费
   地域：广州（重要！必须与云函数同区域）
   数据库版本：4.4
   实例类型：副本集
   规格配置：1核2GB
   存储空间：10GB
   网络：默认VPC
   安全组：默认
   ```
5. 点击"立即购买"
6. 创建完成后（约3-5分钟），设置管理员密码
   - 用户名：`admin`
   - 密码：**请设置一个强密码并记住！**

### ✅ 第二步：获取数据库连接信息

1. 在 MongoDB 实例列表，点击实例ID
2. 进入"实例详情"页面
3. 找到"内网地址"，格式类似：
   ```
   10.0.0.123:27017
   ```
4. 记录这个地址

### ✅ 第三步：修改云函数代码

1. 打开文件：`xiaoci_cloud_function_with_db.js`
2. 找到第16行，修改数据库连接地址：
   ```javascript
   // 修改前：
   const MONGODB_URL = "mongodb://admin:密码@10.x.x.x:27017/xiaoci_stats?authSource=admin";
   
   // 修改后（示例）：
   const MONGODB_URL = "mongodb://admin:你的密码@10.0.0.123:27017/xiaoci_stats?authSource=admin";
   ```
3. 保存文件

### ✅ 第四步：部署到腾讯云函数

1. 登录腾讯云函数：https://console.cloud.tencent.com/scf
2. 找到函数 `xiaoci_stats`，点击进入
3. 点击"函数代码"标签
4. **全选删除**原来的代码
5. 复制 `xiaoci_cloud_function_with_db.js` 的全部内容
6. 粘贴到代码编辑器
7. 点击底部 **"部署"** 按钮

### ✅ 第五步：安装依赖

**方法A：使用 package.json（推荐）**

1. 在"函数代码"页面，找到文件列表
2. 新建文件 `package.json`
3. 输入以下内容：
   ```json
   {
     "name": "xiaoci-stats",
     "version": "1.0.0",
     "dependencies": {
       "mongodb": "^3.6.0"
     }
   }
   ```
4. 点击"保存并安装依赖"
5. 等待安装完成（约1-2分钟）

**方法B：在线安装**

1. 在"函数代码"页面，滚动到底部
2. 找到"依赖管理"
3. 点击"新增依赖"
4. 输入：
   - 依赖名称：`mongodb`
   - 版本：`3.6.0`
5. 点击"安装"

### ✅ 第六步：测试部署

1. 在浏览器访问：
   ```
   https://1381467633-52ewvuipwd.ap-guangzhou.tencentscf.com/
   ```
2. 如果显示：`小瓷连网云服务运行中（数据库版）✓`
   - ✅ 部署成功！

3. 测试统计接口（可选）：
   ```
   访问：https://1381467633-52ewvuipwd.ap-guangzhou.tencentscf.com/dashboard
   ```
   - 应该返回JSON数据

---

## 🧪 测试数据库功能

### 测试流程：

1. **运行程序**
   - 双击 `小瓷连网.exe`
   - 连接校园网成功

2. **等待30秒**
   - 让程序发送统计数据

3. **打开统计面板**
   - 访问：https://pozhu90-alt.github.io/-/
   - 点击"刷新数据"

4. **验证数据**
   - 总用户数应该 ≥ 1
   - DAU（今日活跃）应该 ≥ 1
   - 总启动次数应该 ≥ 1

---

## 🎯 数据库优势

使用数据库后，你将拥有：

### ✅ 永久数据存储
```
以前：云函数休眠 → 数据丢失
现在：数据永久保存在数据库中
```

### ✅ 准确的活跃度统计
```
DAU（日活）：准确统计今天有多少人用过
WAU（周活）：准确统计本周有多少人用过
MAU（月活）：准确统计本月有多少人用过
```

### ✅ 历史趋势分析
```
可以看到：
- 每天新增用户数
- 用户增长曲线
- 留存率分析
```

### ✅ 详细的版本分布
```
实时了解：
- 有多少人用 v1.0.0
- 有多少人更新到 v1.0.1
- 版本升级率
```

---

## 📊 数据结构说明

### users 集合（用户表）
```javascript
{
  deviceId: "ABC123...",      // 设备ID（哈希后）
  firstSeen: ISODate("..."),  // 首次使用时间
  lastSeen: ISODate("..."),   // 最后使用时间
  version: "1.0.0",           // 当前版本
  os: "Windows 10",           // 操作系统
  launchCount: 5              // 累计启动次数
}
```

### launches 集合（启动记录表）
```javascript
{
  deviceId: "ABC123...",      // 设备ID
  version: "1.0.0",           // 版本号
  timestamp: ISODate("..."),  // 启动时间
  os: "Windows 10"            // 操作系统
}
```

---

## ⚠️ 常见问题

### Q1: 部署后显示"Internal Server Error"
**解决方法：**
1. 检查数据库连接地址是否正确
2. 检查密码是否正确
3. 确认云函数和MongoDB在同一地域（都是广州）
4. 查看云函数日志，找到错误信息

### Q2: 依赖安装失败
**解决方法：**
1. 确保 package.json 格式正确（JSON语法）
2. 尝试删除 package.json 后重新创建
3. 使用"在线安装依赖"功能

### Q3: 统计面板还是显示0
**解决方法：**
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 查看是否有错误信息
4. 刷新页面，查看网络请求是否成功

### Q4: MongoDB 免费版够用吗？
**答案：完全够用！**
```
免费版配置：
- 存储：512MB
- 每个用户记录：约 0.5KB
- 可以存储：100万+ 用户记录
```

---

## 📞 需要帮助？

如果遇到问题：
1. 查看腾讯云函数的"日志查询"
2. 查看浏览器控制台的错误信息
3. 告诉我具体的错误信息，我帮你解决

---

## 🎊 配置完成后

你将拥有：
- ✅ 真实准确的用户统计
- ✅ 永久保存的历史数据
- ✅ 专业的数据分析能力
- ✅ 可以导出的详细数据

**祝配置顺利！** 🚀


